"use strict";(self.webpackChunk_dev_app=self.webpackChunk_dev_app||[]).push([[633],{9082:(e,t,n)=>{n.d(t,{L:()=>o,V:()=>s});var a=n(6647),r=n(9385);const o=new a.GraphQLClient(`${location.pathname}graphql`,{headers:{}}),s=(0,r.eI)({url:`${{"https:":"wss:"}[location.protocol]||"ws:"}//${location.host}${location.pathname}subscriptions`})},3633:(e,t,n)=>{n.r(t),n.d(t,{default:()=>k});var a=n(2784),r=n(6647),o=n(7598),s=n(3919),c=n(7984),i=n(9082);const u=r.gql`
  mutation AddMeasurement($measurement: MeasurementInput) {
    addMeasurement(measurement: $measurement)
  }
`,l=r.gql`
  query GetMeasurements {
    getMeasurements {
      date
      temperature
      humidity
    }
  }
`,d=r.gql`
  subscription SensorSubscription {
    sensor {
      data
    }
  }
`,m=new class extends class{client=i.L;subscriptions=i.V}{addMeasurement(e){return(0,o.D)(this.client.request(u,{measurement:e}))}getMeasurements(){return(0,o.D)(this.client.request(l)).pipe((0,c.U)((({getMeasurements:e})=>e)))}onSensor(){return new s.y((e=>this.subscriptions.subscribe({query:d},{next:({data:t,errors:n})=>n?e.error(n[0]):e.next(t),error:t=>e.error(t),complete:()=>e.complete()})))}};var g=n(2401);const f=console.log,v=f,h=f;function b(e){console.error(e)}function p(){console.log("Disconnected.")}let S,M,C,A,y,E,D,w,L=null;function T(e){L.gatt.connect().then((e=>(v("Found GATT server"),A=e,A.getPrimaryService("00010203-0405-0607-0809-0a0b0c0d1912")))).then((e=>(v("Found service"),y=e,y.getCharacteristic("00010203-0405-0607-0809-0a0b0c0d2b12")))).then((t=>{v("Found write characteristic"),E=t,function(e){A.getPrimaryServices().then((t=>{D=!1,w=!1;for(var n=0;n<t.length;n++)console.log("Services: "+t[n].uuid),"ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6"==t[n].uuid&&(D=!0),"00001f10-0000-1000-8000-00805f9b34fb"==t[n].uuid&&(w=!0);D?(f("Detected Mi Thermometer"),h("Detected Mi Thermometer"),function(e){A.getPrimaryService("ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6").then((e=>(v("Found Main service"),S=e,S.getCharacteristic("ebe0ccd8-7a0a-4b0c-8a1a-6ff2997da3a6")))).then((e=>(v("Found Write characteristic Speed"),M=e,S.getCharacteristic("ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6")))).then((t=>(v("Found Temp characteristic"),C=t,C.startNotifications().then((()=>{C.addEventListener("characteristicvaluechanged",(t=>{var n=t.target.value;console.log({value:n});var a=128&n.getUint8(1),r=(127&n.getUint8(1))<<8|n.getUint8(0);a&&(r-=32767),r/=100;var o=n.getUint8(2),s="Temp/Humi: "+r+"Â°C / "+o+"%";document.getElementById("tempHumiData").innerHTML=s,v(s),e({date:Date.now(),temperature:r,humidity:o})}))}))))).catch(b)}(e)):w?(f("Detected custom Firmware"),h("Detected custom Firmware")):(f("Connected"),h("Connected"))})).catch(b)}(e)})).catch(b)}function k(){const[{measurements:e,values:t},{addMeasurement:n}]=function(){const[{measurements:e,values:t},n]=(0,a.useState)((()=>({measurements:null,values:null})));return(0,a.useEffect)((()=>{const e=[m.onSensor().subscribe((({sensor:e})=>n((({values:t,...n})=>({...n,values:(t||[]).concat([e])})))))];return m.getMeasurements().subscribe((e=>n((t=>({...t,measurements:e}))))),()=>{e.map((e=>e.unsubscribe()))}}),[]),[{measurements:e,values:t},{addMeasurement:e=>m.addMeasurement(e)}]}();console.log({measurements:e,values:t}),(0,a.useEffect)((()=>{}),[]);const r=(0,a.useCallback)((e=>{null!==L&&L.gatt.disconnect(),f("Reconnect"),T(n)}),[n]),o=(0,a.useCallback)((e=>{const t={filters:[{name:"LYWSD03MMC"},{services:[65173]}],optionalServices:["00010203-0405-0607-0809-0a0b0c0d1912","ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6",65173,7952]};navigator.bluetooth.getAvailability().then((e=>{e&&navigator.bluetooth.requestDevice(t).then((e=>{console.log({device:e}),L=e,function(e){const t=new AbortController;e.addEventListener("advertisementreceived",(n=>{console.log('Received advertisement from "'+e.name+'"...'),n.serviceData.forEach((t=>{const a=new Uint8Array(t.buffer);console.log(a,e,n),"LYWSD03MMC"==e.name&&(console.log("LYWSD03MMC MAC:",a[10].toString(16),a[9].toString(16),a[8].toString(16),a[7].toString(16),a[6].toString(16),a[5].toString(16)),document.getElementById("MAC").innerHTML="LYWSD03MMC MAC: "+a[10].toString(16)+a[9].toString(16)+a[8].toString(16)+a[7].toString(16)+a[6].toString(16)+a[5].toString(16)),e.name.startsWith("ATC")?(console.log("ATC MAC:",a[0].toString(16),a[1].toString(16),a[2].toString(16),a[3].toString(16),a[4].toString(16),a[5].toString(16)),document.getElementById("MAC").innerHTML="ATC MAC: "+a[0].toString(16)+a[1].toString(16)+a[2].toString(16)+a[3].toString(16)+a[4].toString(16)+a[5].toString(16)):console.log("only LYWSD03MMC/ATC supported")})),t.abort()}),{once:!0})}(e),L.addEventListener("gattserverdisconnected",p),f("Connecting to: "+L.name),T(n)})).catch(b)}))}),[n]);return a.createElement("section",{className:g.Z.Section},a.createElement("span",null,"LYWSD03MMC"),a.createElement("button",{onClick:o},"Connect"),a.createElement("button",{onClick:r},"Reconnect"),a.createElement("button",{onClick:(0,a.useCallback)((()=>n({date:Date.now(),temperature:22,humidity:60})),[])},"Measurement"),a.createElement("span",{id:"tempHumiData"}),a.createElement("span",{id:"MAC"}),null===t?a.createElement("div",null,"Loading..."):t.map(((e,t)=>a.createElement("div",{key:t},JSON.stringify(e)))))}},1408:(e,t,n)=>{n.r(t),n.d(t,{default:()=>c});var a=n(272),r=n.n(a),o=n(2609),s=n.n(o)()(r());s.push([e.id,".BUVMpFXG9cmk5ZtAw0Oh{color:purple}","",{version:3,sources:["webpack://./../web/src/containers/Sensor/styles.module.scss"],names:[],mappings:"AAAA,sBACE,YAAA",sourcesContent:[".Section {\n  color: purple;\n}\n"],sourceRoot:""}]),s.locals={Section:"BUVMpFXG9cmk5ZtAw0Oh"};const c=s},7984:(e,t,n)=>{n.d(t,{U:()=>o});var a=n(1118),r=n(7394);function o(e,t){return(0,a.e)((function(n,a){var o=0;n.subscribe((0,r.x)(a,(function(n){a.next(e.call(t,n,o++))})))}))}},2401:(e,t,n)=>{n.d(t,{Z:()=>M});var a=n(6062),r=n.n(a),o=n(4036),s=n.n(o),c=n(6793),i=n.n(c),u=n(7892),l=n.n(u),d=n(1173),m=n.n(d),g=n(2464),f=n.n(g),v=n(1408),h={};h.styleTagTransform=f(),h.setAttributes=l(),h.insert=i().bind(null,"head"),h.domAPI=s(),h.insertStyleElement=m();var b=r()(v.default,h);if(!v.default.locals||e.hot.invalidate){var p=!v.default.locals,S=p?v:v.default.locals;e.hot.accept(1408,(t=>{v=n(1408),function(e,t,n){if(!e&&t||e&&!t)return!1;var a;for(a in e)if((!n||"default"!==a)&&e[a]!==t[a])return!1;for(a in t)if(!(n&&"default"===a||e[a]))return!1;return!0}(S,p?v:v.default.locals,p)?(S=p?v:v.default.locals,b(v.default)):e.hot.invalidate()}))}e.hot.dispose((function(){b()}));const M=v.default&&v.default.locals?v.default.locals:void 0}}]);
//# sourceMappingURL=633.js.map