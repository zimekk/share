{"version":3,"file":"500.js","mappings":"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","sources":["webpack://@dev/app/../client/src/index.ts","webpack://@dev/app/../video/src/containers/Video/index.tsx","webpack://@dev/app/../video/src/containers/Video/styles.module.scss","webpack://@dev/app/../video/src/containers/Video/styles.module.scss?ac7e"],"sourcesContent":["import { GraphQLClient } from \"graphql-request\";\nimport { createClient } from \"graphql-ws\";\n\n// https://shammelburg.medium.com/subscriptions-with-graphql-dfa8279af050\n// https://github.com/shammelburg/graphql-rxjs-angular/blob/main/src/app/services/graphql.service.ts\nexport const client = new GraphQLClient(`${location.pathname}graphql`, {\n  headers: {\n    // authorization: `Bearer ${localStorage.getItem('token')}`,\n  },\n});\n\nexport const subscriptions = createClient({\n  url: `${{ \"https:\": \"wss:\" }[location.protocol] || \"ws:\"}//${location.host}${\n    location.pathname\n  }subscriptions`,\n});\n","import React, { useEffect, useRef, useState } from \"react\";\nimport Peer from \"simple-peer\";\nimport { gql } from \"graphql-request\";\nimport { from, Observable } from \"rxjs\";\nimport { client, subscriptions } from \"@dev/client\";\nimport styles from \"./styles.module.scss\";\n\nclass Service {\n  client = client;\n  subscriptions = subscriptions;\n}\n\nconst ON_SIGNAL = gql`\n  subscription SignalSubscription {\n    signal {\n      sdp\n      type\n      candidate {\n        candidate\n        sdpMLineIndex\n        sdpMid\n      }\n    }\n  }\n`;\n\nconst SEND_SIGNAL = gql`\n  mutation SendSignalMutation($signal: SignalInput) {\n    sendSignal(signal: $signal)\n  }\n`;\n\nexport class VideoService extends Service {\n  sendSignal(signal) {\n    return from(this.client.request(SEND_SIGNAL, { signal }));\n  }\n  onSignal() {\n    return new Observable((observer) =>\n      this.subscriptions.subscribe(\n        { query: ON_SIGNAL },\n        {\n          next: ({ data, errors }) =>\n            errors ? observer.error(errors[0]) : observer.next(data),\n          error: (error) => observer.error(error),\n          complete: () => observer.complete(),\n        }\n      )\n    );\n  }\n}\n\nconst videoService = new VideoService();\n\nexport function useVideo() {\n  const [state, setState] = useState({ hello: null });\n\n  useEffect(() => {\n    const subscriptions = [\n      videoService\n        .onSignal()\n        .subscribe(({ signal }) => setState((state) => ({ ...state, signal }))),\n    ];\n    return () => {\n      subscriptions.map((it) => it.unsubscribe());\n    };\n  }, []);\n\n  return [state, { sendSignal: (signal) => videoService.sendSignal(signal) }];\n}\n\nexport default function Video() {\n  const [data, { sendSignal }] = useVideo();\n  const [initiator, setInitiator] = useState(undefined);\n  const [stream, setStream] = useState(null);\n  const peerRef = useRef(null);\n  const localVideoRef = useRef(null);\n  const remoteVideoRef = useRef(null);\n\n  useEffect(() => {\n    if (data && peerRef.current) {\n      const { type } = data.signal;\n\n      if (type === \"offer\" && initiator) return;\n      if (type === \"answer\" && !initiator) return;\n\n      console.log([\"peer.signal\"], data.signal);\n      peerRef.current.signal(data.signal);\n    }\n  }, [data, peerRef, initiator]);\n\n  useEffect(() => {\n    if (initiator !== undefined) {\n      console.log({ initiator });\n\n      Promise.resolve()\n        .then(() =>\n          initiator\n            ? navigator.mediaDevices.getUserMedia({\n                video: {\n                  facingMode: \"user\",\n                },\n                audio: false,\n              })\n            : Promise.resolve(null)\n        )\n        .then((stream) => {\n          setStream(stream);\n\n          const peer = new Peer({\n            initiator,\n            stream,\n            trickle: false,\n            reconnectTimer: 1000,\n            iceTransportPolicy: \"relay\",\n            config: {\n              iceServers: [\n                { urls: \"stun:stun.l.google.com:19302\" },\n                { urls: \"stun:stun.services.mozilla.com\" },\n              ],\n            },\n          })\n            .on(\"signal\", (data) => {\n              console.log([\"signal\", initiator], { data });\n              sendSignal(data);\n            })\n            .on(\"stream\", (stream) => {\n              console.log([\"stream\", initiator], { stream });\n              Object.assign(remoteVideoRef.current, {\n                srcObject: stream,\n              });\n            })\n            .on(\"error\", function (error) {\n              console.log([\"error\", initiator], { error });\n            });\n          peerRef.current = peer;\n        })\n        .catch(console.error);\n    }\n  }, [initiator]);\n\n  useEffect(() => {\n    if (stream) {\n      const videoTracks = stream.getVideoTracks();\n      console.log({ stream, videoTracks });\n      Object.assign(localVideoRef.current, {\n        srcObject: stream,\n      });\n\n      return () => {\n        stream.getTracks().forEach((track) => track.stop());\n      };\n    }\n  }, [stream]);\n\n  return (\n    <div className={styles.Video}>\n      <button onClick={() => setInitiator(true)}>setInitiator(true)</button>\n      <button onClick={() => setInitiator(false)}>setInitiator(false)</button>\n      <video ref={localVideoRef} width=\"200\" autoPlay muted playsInline />\n      <video ref={remoteVideoRef} width=\"200\" autoPlay muted />\n    </div>\n  );\n}\n","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, \".kvevXXBTh098bMXqbTDA{color:green}\", \"\",{\"version\":3,\"sources\":[\"webpack://./../video/src/containers/Video/styles.module.scss\"],\"names\":[],\"mappings\":\"AAAA,sBACE,WAAA\",\"sourcesContent\":[\".Video {\\n  color: green;\\n}\\n\"],\"sourceRoot\":\"\"}]);\n// Exports\n___CSS_LOADER_EXPORT___.locals = {\n\t\"Video\": \"kvevXXBTh098bMXqbTDA\"\n};\nexport default ___CSS_LOADER_EXPORT___;\n","\n      import API from \"!../../../../../node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js\";\n      import domAPI from \"!../../../../../node_modules/style-loader/dist/runtime/styleDomAPI.js\";\n      import insertFn from \"!../../../../../node_modules/style-loader/dist/runtime/insertBySelector.js\";\n      import setAttributes from \"!../../../../../node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js\";\n      import insertStyleElement from \"!../../../../../node_modules/style-loader/dist/runtime/insertStyleElement.js\";\n      import styleTagTransformFn from \"!../../../../../node_modules/style-loader/dist/runtime/styleTagTransform.js\";\n      import content, * as namedExport from \"!!../../../../../node_modules/css-loader/dist/cjs.js!../../../../../node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[0].use[2]!./styles.module.scss\";\n      \n      \n\nvar options = {};\n\noptions.styleTagTransform = styleTagTransformFn;\noptions.setAttributes = setAttributes;\n\n      options.insert = insertFn.bind(null, \"head\");\n    \noptions.domAPI = domAPI;\noptions.insertStyleElement = insertStyleElement;\n\nvar update = API(content, options);\n\n\nif (module.hot) {\n  if (!content.locals || module.hot.invalidate) {\n    var isEqualLocals = function isEqualLocals(a, b, isNamedExport) {\n  if (!a && b || a && !b) {\n    return false;\n  }\n\n  var p;\n\n  for (p in a) {\n    if (isNamedExport && p === \"default\") {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (a[p] !== b[p]) {\n      return false;\n    }\n  }\n\n  for (p in b) {\n    if (isNamedExport && p === \"default\") {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (!a[p]) {\n      return false;\n    }\n  }\n\n  return true;\n};\n    var isNamedExport = !content.locals;\n    var oldLocals = isNamedExport ? namedExport : content.locals;\n\n    module.hot.accept(\n      \"!!../../../../../node_modules/css-loader/dist/cjs.js!../../../../../node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[0].use[2]!./styles.module.scss\",\n      function () {\n        if (!isEqualLocals(oldLocals, isNamedExport ? namedExport : content.locals, isNamedExport)) {\n                module.hot.invalidate();\n\n                return;\n              }\n\n              oldLocals = isNamedExport ? namedExport : content.locals;\n\n              update(content);\n      }\n    )\n  }\n\n  module.hot.dispose(function() {\n    update();\n  });\n}\n\n\nexport * from \"!!../../../../../node_modules/css-loader/dist/cjs.js!../../../../../node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[0].use[2]!./styles.module.scss\";\n       export default content && content.locals ? content.locals : undefined;\n"],"names":["client","GraphQLClient","location","pathname","headers","subscriptions","createClient","url","protocol","host","ON_SIGNAL","gql","SEND_SIGNAL","videoService","sendSignal","signal","from","this","request","onSignal","Observable","observer","subscribe","query","next","data","errors","error","complete","Video","state","setState","useState","hello","useEffect","map","it","unsubscribe","useVideo","initiator","setInitiator","undefined","stream","setStream","peerRef","useRef","localVideoRef","remoteVideoRef","current","type","console","log","Promise","resolve","then","navigator","mediaDevices","getUserMedia","video","facingMode","audio","peer","Peer","trickle","reconnectTimer","iceTransportPolicy","config","iceServers","urls","on","Object","assign","srcObject","catch","videoTracks","getVideoTracks","getTracks","forEach","track","stop","className","styles","onClick","ref","width","autoPlay","muted","playsInline","___CSS_LOADER_EXPORT___","push","module","id","locals","options","styleTagTransform","setAttributes","insert","domAPI","insertStyleElement","update","hot","invalidate","isNamedExport","oldLocals","accept","a","b","p","isEqualLocals","dispose"],"sourceRoot":""}